<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      padding: 20px;
    }
    .container { max-width: 1100px; margin: 0 auto; }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { font-size: 1.5em; }
    .deal-selector {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .deal-selector select {
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      min-width: 300px;
    }
    .main-content {
      background: white;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .tabs {
      display: flex;
      border-bottom: 2px solid #e0e0e0;
    }
    .tab {
      padding: 15px 25px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
      font-weight: 500;
    }
    .tab:hover { background: #f5f5f5; }
    .tab.active {
      border-bottom-color: #667eea;
      color: #667eea;
    }
    .tab-content { padding: 25px; display: none; }
    .tab-content.active { display: block; }
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    .metric-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      border: 1px solid #e0e0e0;
    }
    .metric-card.hot { background: #e8f5e9; border-color: #4CAF50; }
    .metric-card.warning { background: #fff3e0; border-color: #FF9800; }
    .metric-card.danger { background: #ffebee; border-color: #f44336; }
    .metric-value {
      font-size: 2em;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }
    .metric-label { color: #666; font-size: 0.9em; }
    .strategy-comparison {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    .strategy-card {
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      border: 2px solid #e0e0e0;
      transition: all 0.3s;
    }
    .strategy-card.best {
      border-color: #4CAF50;
      background: #e8f5e9;
    }
    .strategy-card h3 {
      color: #667eea;
      margin-bottom: 10px;
    }
    .strategy-score {
      font-size: 2.5em;
      font-weight: bold;
      margin: 10px 0;
    }
    .strategy-verdict {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
    }
    .verdict-strong { background: #4CAF50; color: white; }
    .verdict-good { background: #2196F3; color: white; }
    .verdict-viable { background: #FF9800; color: white; }
    .verdict-pass { background: #9e9e9e; color: white; }
    .section-title {
      font-size: 1.2em;
      color: #333;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }
    .detail-label { color: #666; }
    .detail-value { font-weight: 600; color: #333; }
    .offer-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }
    .offer-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
    }
    .offer-card h4 {
      color: #667eea;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .offer-price {
      font-size: 1.8em;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }
    .offer-terms { color: #666; font-size: 0.9em; line-height: 1.5; }
    .message-box {
      background: #e3f2fd;
      padding: 20px;
      border-radius: 10px;
      border-left: 4px solid #2196F3;
    }
    .message-box h4 { margin-bottom: 10px; color: #1976D2; }
    .message-box p { line-height: 1.6; white-space: pre-wrap; }
    .psychology-box {
      background: #f3e5f5;
      padding: 20px;
      border-radius: 10px;
      border-left: 4px solid #9c27b0;
      margin-top: 20px;
    }
    .risk-meter {
      height: 20px;
      background: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }
    .risk-fill {
      height: 100%;
      border-radius: 10px;
      transition: width 0.5s;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 0.95em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover { transform: translateY(-2px); }
    .loading { text-align: center; padding: 40px; color: #666; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Deal Analyzer</h1>
      <div class="deal-selector">
        <select id="deal-select" onchange="loadDeal()">
          <option value="">-- Select a Deal --</option>
        </select>
        <button class="btn btn-primary" onclick="refreshAnalysis()">Refresh</button>
      </div>
    </div>

    <div class="main-content">
      <div class="tabs">
        <div class="tab active" onclick="showTab('overview')">Overview</div>
        <div class="tab" onclick="showTab('strategies')">Strategy Analysis</div>
        <div class="tab" onclick="showTab('offers')">Offer Pack</div>
        <div class="tab" onclick="showTab('messaging')">Messaging</div>
      </div>

      <!-- Overview Tab -->
      <div class="tab-content active" id="tab-overview">
        <div class="metrics-grid">
          <div class="metric-card" id="card-verdict">
            <div class="metric-value" id="deal-verdict">--</div>
            <div class="metric-label">Verdict</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="deal-score">--</div>
            <div class="metric-label">Deal Score</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="risk-score">--</div>
            <div class="metric-label">Risk Score</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="best-strategy">--</div>
            <div class="metric-label">Best Strategy</div>
          </div>
        </div>

        <h3 class="section-title">Property Details</h3>
        <div class="detail-row">
          <span class="detail-label">Address</span>
          <span class="detail-value" id="prop-address">--</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Asking Price</span>
          <span class="detail-value" id="prop-asking">--</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">ARV</span>
          <span class="detail-value" id="prop-arv">--</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Beds / Baths / Sqft</span>
          <span class="detail-value" id="prop-size">--</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Year Built</span>
          <span class="detail-value" id="prop-year">--</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Days on Market</span>
          <span class="detail-value" id="prop-dom">--</span>
        </div>

        <h3 class="section-title" style="margin-top: 25px;">Market Intelligence</h3>
        <div class="detail-row">
          <span class="detail-label">Sales Velocity</span>
          <span class="detail-value" id="market-velocity">--</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Exit Speed Tier</span>
          <span class="detail-value" id="market-exit-tier">--</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">SOM Score</span>
          <span class="detail-value" id="market-som">--</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Market Heat</span>
          <span class="detail-value" id="market-heat">--</span>
        </div>

        <h3 class="section-title" style="margin-top: 25px;">Repair Estimate</h3>
        <div class="detail-row">
          <span class="detail-label">Complexity Tier</span>
          <span class="detail-value" id="repair-tier">--</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Rehab Range</span>
          <span class="detail-value" id="repair-range">--</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Repair Risk Score</span>
          <span class="detail-value" id="repair-risk">--</span>
        </div>
      </div>

      <!-- Strategies Tab -->
      <div class="tab-content" id="tab-strategies">
        <h3 class="section-title">Multi-Exit Strategy Comparison</h3>
        <div class="strategy-comparison">
          <div class="strategy-card" id="strategy-flip">
            <h3>FLIP</h3>
            <div class="strategy-score" id="flip-score">--</div>
            <div class="strategy-verdict" id="flip-verdict">--</div>
            <p style="margin-top: 10px; font-size: 0.9em; color: #666;" id="flip-profit">--</p>
          </div>
          <div class="strategy-card" id="strategy-str">
            <h3>STR</h3>
            <div class="strategy-score" id="str-score">--</div>
            <div class="strategy-verdict" id="str-verdict">--</div>
            <p style="margin-top: 10px; font-size: 0.9em; color: #666;" id="str-cashflow">--</p>
          </div>
          <div class="strategy-card" id="strategy-mtr">
            <h3>MTR</h3>
            <div class="strategy-score" id="mtr-score">--</div>
            <div class="strategy-verdict" id="mtr-verdict">--</div>
            <p style="margin-top: 10px; font-size: 0.9em; color: #666;" id="mtr-cashflow">--</p>
          </div>
          <div class="strategy-card" id="strategy-ltr">
            <h3>LTR</h3>
            <div class="strategy-score" id="ltr-score">--</div>
            <div class="strategy-verdict" id="ltr-verdict">--</div>
            <p style="margin-top: 10px; font-size: 0.9em; color: #666;" id="ltr-dscr">--</p>
          </div>
          <div class="strategy-card" id="strategy-creative">
            <h3>CREATIVE</h3>
            <div class="strategy-score" id="creative-score">--</div>
            <div class="strategy-verdict" id="creative-verdict">--</div>
            <p style="margin-top: 10px; font-size: 0.9em; color: #666;" id="creative-type">--</p>
          </div>
        </div>

        <h3 class="section-title" style="margin-top: 30px;">Risk Assessment</h3>
        <p style="margin-bottom: 10px;">Exit Risk Level</p>
        <div class="risk-meter">
          <div class="risk-fill" id="exit-risk-fill" style="width: 0%; background: #4CAF50;"></div>
        </div>
        <p id="exit-risk-label" style="text-align: right; color: #666;">--</p>
      </div>

      <!-- Offers Tab -->
      <div class="tab-content" id="tab-offers">
        <h3 class="section-title">Generated Offer Pack</h3>
        <div class="offer-grid">
          <div class="offer-card">
            <h4>Cash Offer</h4>
            <div class="offer-price" id="offer-cash-price">--</div>
            <div class="offer-terms" id="offer-cash-terms">--</div>
          </div>
          <div class="offer-card">
            <h4>Subject-To</h4>
            <div class="offer-price" id="offer-sub2-price">--</div>
            <div class="offer-terms" id="offer-sub2-terms">--</div>
          </div>
          <div class="offer-card">
            <h4>Wrap Mortgage</h4>
            <div class="offer-price" id="offer-wrap-price">--</div>
            <div class="offer-terms" id="offer-wrap-terms">--</div>
          </div>
          <div class="offer-card">
            <h4>Seller Carry</h4>
            <div class="offer-price" id="offer-carry-price">--</div>
            <div class="offer-terms" id="offer-carry-terms">--</div>
          </div>
          <div class="offer-card">
            <h4>Lease Option</h4>
            <div class="offer-price" id="offer-lo-price">--</div>
            <div class="offer-terms" id="offer-lo-terms">--</div>
          </div>
          <div class="offer-card">
            <h4>Hybrid</h4>
            <div class="offer-price" id="offer-hybrid-price">--</div>
            <div class="offer-terms" id="offer-hybrid-terms">--</div>
          </div>
        </div>

        <h3 class="section-title" style="margin-top: 30px;">Recommended Offer</h3>
        <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; border: 2px solid #4CAF50;">
          <p><strong>Type:</strong> <span id="rec-offer-type">--</span></p>
          <p><strong>Price:</strong> <span id="rec-offer-price">--</span></p>
          <p><strong>Terms:</strong> <span id="rec-offer-terms">--</span></p>
          <p style="margin-top: 10px; color: #666;"><strong>Risk Notes:</strong> <span id="rec-offer-risk">--</span></p>
        </div>
      </div>

      <!-- Messaging Tab -->
      <div class="tab-content" id="tab-messaging">
        <h3 class="section-title">First Touch Message</h3>
        <div class="message-box">
          <h4>Seller Outreach Message</h4>
          <p id="seller-message">--</p>
        </div>

        <div class="psychology-box">
          <h4 style="color: #7b1fa2;">Seller Psychology Profile</h4>
          <p id="psychology-profile">--</p>
        </div>

        <h3 class="section-title" style="margin-top: 25px;">Follow-Up Strategy</h3>
        <div class="detail-row">
          <span class="detail-label">Sequence Tag</span>
          <span class="detail-value" id="followup-tag">--</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Deniability Angle</span>
          <span class="detail-value" id="deniability">--</span>
        </div>

        <button class="btn btn-primary" style="margin-top: 20px;" onclick="regenerateMessage()">
          Regenerate Message
        </button>
      </div>
    </div>
  </div>

  <script>
    let currentDealId = null;

    function showTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      event.target.classList.add('active');
      document.getElementById('tab-' + tabName).classList.add('active');
    }

    function loadDeals() {
      google.script.run
        .withSuccessHandler(function(deals) {
          const select = document.getElementById('deal-select');
          select.innerHTML = '<option value="">-- Select a Deal --</option>';
          deals.forEach(deal => {
            const option = document.createElement('option');
            option.value = deal['Deal ID'];
            option.textContent = deal['Address'] + ' - ' + deal['Verdict'];
            select.appendChild(option);
          });
        })
        .getTopDeals(50);
    }

    function loadDeal() {
      const dealId = document.getElementById('deal-select').value;
      if (!dealId) return;

      currentDealId = dealId;

      // Load verdict data
      google.script.run
        .withSuccessHandler(populateDealData)
        .getVerdictForDeal(dealId);

      // Load offer pack
      google.script.run
        .withSuccessHandler(populateOfferData)
        .getOfferPackForDeal(dealId);

      // Load messaging
      google.script.run
        .withSuccessHandler(populateMessaging)
        .getMessageForDeal(dealId);
    }

    function populateDealData(deal) {
      if (deal.error) {
        alert('Error loading deal: ' + deal.error);
        return;
      }

      // Overview metrics
      document.getElementById('deal-verdict').textContent = deal['Verdict'] || '--';
      document.getElementById('deal-score').textContent = deal['Deal Score'] || '--';
      document.getElementById('risk-score').textContent = deal['Risk Score'] || '--';
      document.getElementById('best-strategy').textContent = deal['Best Strategy'] || '--';

      // Color code verdict card
      const verdictCard = document.getElementById('card-verdict');
      verdictCard.className = 'metric-card';
      if (deal['Verdict'] === 'HOT') verdictCard.classList.add('hot');
      else if (deal['Verdict'] === 'PASS') verdictCard.classList.add('danger');
      else if (deal['Verdict'] === 'HOLD') verdictCard.classList.add('warning');

      // Property details
      document.getElementById('prop-address').textContent = deal['Address'] || '--';
      document.getElementById('prop-asking').textContent = formatCurrency(deal['Asking Price']);
      document.getElementById('prop-arv').textContent = formatCurrency(deal['ARV']);
      document.getElementById('prop-dom').textContent = deal['DOM'] || '--';

      // Market data
      document.getElementById('market-velocity').textContent = deal['Sales Velocity Score'] || '--';
      document.getElementById('market-exit-tier').textContent = deal['Exit Speed Tier'] || '--';
      document.getElementById('market-som').textContent = deal['SOM Score'] || '--';
    }

    function populateOfferData(offerPack) {
      if (offerPack.error) return;

      // Cash offer
      if (offerPack.cashOffer) {
        document.getElementById('offer-cash-price').textContent = formatCurrency(offerPack.cashOffer.price);
        document.getElementById('offer-cash-terms').textContent = offerPack.cashOffer.terms || '--';
      }

      // Sub2
      if (offerPack.sub2Offer) {
        document.getElementById('offer-sub2-price').textContent = formatCurrency(offerPack.sub2Offer.price);
        document.getElementById('offer-sub2-terms').textContent = offerPack.sub2Offer.terms || '--';
      }

      // Recommended
      if (offerPack.recommended) {
        document.getElementById('rec-offer-type').textContent = offerPack.recommended.type;
        document.getElementById('rec-offer-price').textContent = formatCurrency(offerPack.recommended.price);
        document.getElementById('rec-offer-terms').textContent = offerPack.recommended.terms;
        document.getElementById('rec-offer-risk').textContent = offerPack.recommended.riskNotes;
      }
    }

    function populateMessaging(messaging) {
      if (messaging.error) return;

      document.getElementById('seller-message').textContent = messaging.sellerMessage || '--';
      document.getElementById('psychology-profile').textContent = messaging.psychologyProfile || '--';
      document.getElementById('followup-tag').textContent = messaging.followUpTag || '--';
      document.getElementById('deniability').textContent = messaging.deniabilityAngle || '--';
    }

    function formatCurrency(value) {
      if (!value) return '--';
      return '$' + parseInt(value).toLocaleString();
    }

    function refreshAnalysis() {
      if (currentDealId) {
        loadDeal();
      }
    }

    function regenerateMessage() {
      if (!currentDealId) return;

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.message) {
            document.getElementById('seller-message').textContent = result.message;
          }
        })
        .regenerateMessage(currentDealId, false);
    }

    // Initialize
    loadDeals();
  </script>
</body>
</html>
