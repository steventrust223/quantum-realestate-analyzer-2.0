<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports & Analytics - Quantum Real Estate Analyzer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .nav-header {
            background: white;
            padding: 15px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-header h1 { color: #667eea; font-size: 1.5em; }
        .back-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
        }
        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .card h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .btn:hover { opacity: 0.9; }
        .btn-secondary { background: #6c757d; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 15px;
            color: white;
            text-align: center;
        }
        .stat-card.green { background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); }
        .stat-card.orange { background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); }
        .stat-card.blue { background: linear-gradient(135deg, #2196f3 0%, #1565c0 100%); }
        .stat-value { font-size: 2.5em; font-weight: bold; }
        .stat-label { font-size: 14px; opacity: 0.9; margin-top: 5px; }
        .stat-change { font-size: 12px; margin-top: 10px; }
        .stat-change.positive { color: #a5d6a7; }
        .stat-change.negative { color: #ef9a9a; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }
        .chart-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            min-height: 250px;
        }
        .chart-bar {
            display: flex;
            align-items: flex-end;
            height: 200px;
            gap: 15px;
            padding: 20px;
        }
        .bar-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .bar {
            width: 100%;
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 5px 5px 0 0;
            transition: height 0.5s ease;
        }
        .bar-label { font-size: 11px; color: #666; margin-top: 5px; text-align: center; }
        .bar-value { font-size: 12px; font-weight: bold; color: #333; margin-bottom: 5px; }
        .donut-chart {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: conic-gradient(
                #4caf50 0deg var(--wholesale-deg),
                #2196f3 var(--wholesale-deg) var(--sub2-deg),
                #ff9800 var(--sub2-deg) 360deg
            );
            position: relative;
            margin: 0 auto;
        }
        .donut-hole {
            position: absolute;
            width: 120px;
            height: 120px;
            background: white;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .donut-value { font-size: 2em; font-weight: bold; color: #333; }
        .donut-label { font-size: 12px; color: #666; }
        .legend { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
        .legend-item { display: flex; align-items: center; gap: 5px; font-size: 12px; }
        .legend-color { width: 15px; height: 15px; border-radius: 3px; }
        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        .metric-row:last-child { border-bottom: none; }
        .metric-name { color: #666; }
        .metric-value { font-weight: bold; color: #333; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        th { background: #f8f9fa; font-weight: 600; color: #333; }
        tr:hover { background: #f8f9fa; }
        .trend-up { color: #4caf50; }
        .trend-down { color: #f44336; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .kpi-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .kpi-info h4 { color: #333; margin-bottom: 5px; }
        .kpi-info p { font-size: 12px; color: #666; }
        .kpi-value { font-size: 1.8em; font-weight: bold; color: #667eea; }
        .export-btns { display: flex; gap: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-header">
            <h1>Reports & Analytics Dashboard</h1>
            <a href="control-center.html" class="back-btn">Back to Control Center</a>
        </div>

        <!-- Key Metrics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalRevenue">$0</div>
                <div class="stat-label">Total Revenue</div>
                <div class="stat-change positive" id="revenueChange">+0% from last period</div>
            </div>
            <div class="stat-card green">
                <div class="stat-value" id="totalDeals">0</div>
                <div class="stat-label">Total Deals</div>
                <div class="stat-change positive" id="dealsChange">0 closed</div>
            </div>
            <div class="stat-card orange">
                <div class="stat-value" id="avgDealSize">$0</div>
                <div class="stat-label">Avg Deal Size</div>
                <div class="stat-change">Per closed deal</div>
            </div>
            <div class="stat-card blue">
                <div class="stat-value" id="conversionRate">0%</div>
                <div class="stat-label">Conversion Rate</div>
                <div class="stat-change">Lead to Close</div>
            </div>
        </div>

        <div class="grid-2">
            <!-- Deal Distribution -->
            <div class="card">
                <h2>Deal Type Distribution</h2>
                <div class="chart-container">
                    <div class="donut-chart" id="dealDonut" style="--wholesale-deg: 180deg; --sub2-deg: 270deg;">
                        <div class="donut-hole">
                            <div class="donut-value" id="donutTotal">0</div>
                            <div class="donut-label">Total Deals</div>
                        </div>
                    </div>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #4caf50;"></div>
                            <span>Wholesaling (<span id="wsCount">0</span>)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #2196f3;"></div>
                            <span>Sub2 (<span id="s2Count">0</span>)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ff9800;"></div>
                            <span>Other (<span id="otherCount">0</span>)</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pipeline Metrics -->
            <div class="card">
                <h2>Pipeline Performance</h2>
                <div class="chart-container">
                    <div class="chart-bar" id="pipelineChart">
                        <!-- Bars will be generated dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- KPIs -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; border: none; padding: 0;">Key Performance Indicators</h2>
                <div class="export-btns">
                    <button class="btn btn-secondary" onclick="exportReport('csv')">Export CSV</button>
                    <button class="btn" onclick="exportReport('json')">Export JSON</button>
                </div>
            </div>

            <div class="kpi-grid">
                <div class="kpi-item">
                    <div class="kpi-info">
                        <h4>Properties Analyzed</h4>
                        <p>Total quantum analyses run</p>
                    </div>
                    <div class="kpi-value" id="propertiesAnalyzed">0</div>
                </div>
                <div class="kpi-item">
                    <div class="kpi-info">
                        <h4>Active Buyers</h4>
                        <p>Ready to purchase</p>
                    </div>
                    <div class="kpi-value" id="activeBuyers">0</div>
                </div>
                <div class="kpi-item">
                    <div class="kpi-info">
                        <h4>Active Sellers</h4>
                        <p>Motivated leads</p>
                    </div>
                    <div class="kpi-value" id="activeSellers">0</div>
                </div>
                <div class="kpi-item">
                    <div class="kpi-info">
                        <h4>Pending Tasks</h4>
                        <p>Action items</p>
                    </div>
                    <div class="kpi-value" id="pendingTasks">0</div>
                </div>
            </div>
        </div>

        <!-- Revenue Breakdown -->
        <div class="card">
            <h2>Revenue Analysis</h2>
            <div class="grid-2">
                <div>
                    <h3 style="margin-bottom: 15px; color: #333;">Revenue by Deal Type</h3>
                    <div class="metric-row">
                        <span class="metric-name">Wholesaling Revenue</span>
                        <span class="metric-value" id="wsRevenue">$0</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-name">Sub2 Revenue</span>
                        <span class="metric-value" id="s2Revenue">$0</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-name">Other Revenue</span>
                        <span class="metric-value" id="otherRevenue">$0</span>
                    </div>
                    <div class="metric-row" style="background: #f8f9fa; margin: 10px -15px -15px; padding: 15px;">
                        <span class="metric-name" style="font-weight: bold;">Total Profit</span>
                        <span class="metric-value" style="color: #4caf50;" id="totalProfit">$0</span>
                    </div>
                </div>
                <div>
                    <h3 style="margin-bottom: 15px; color: #333;">Performance Metrics</h3>
                    <div class="metric-row">
                        <span class="metric-name">Average Time to Close</span>
                        <span class="metric-value" id="avgCloseTime">-- days</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-name">Lead Response Rate</span>
                        <span class="metric-value" id="responseRate">--%</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-name">Deals in Pipeline</span>
                        <span class="metric-value" id="pipelineDeals">0</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-name">Pipeline Value</span>
                        <span class="metric-value" id="pipelineValue">$0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="card">
            <h2>Recent Closed Deals</h2>
            <table>
                <thead>
                    <tr>
                        <th>Property</th>
                        <th>Type</th>
                        <th>Purchase Price</th>
                        <th>Profit/Fee</th>
                        <th>Closed Date</th>
                    </tr>
                </thead>
                <tbody id="recentDealsBody">
                    <tr><td colspan="5" style="text-align: center; color: #999; padding: 30px;">No closed deals yet</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        async function loadAnalytics() {
            try {
                const [analyticsRes, reportRes, dashboardRes] = await Promise.all([
                    fetch(`${API_BASE}/analytics`),
                    fetch(`${API_BASE}/reports/summary`),
                    fetch(`${API_BASE}/dashboard`)
                ]);

                const analytics = await analyticsRes.json();
                const report = await reportRes.json();
                const dashboard = await dashboardRes.json();

                if (analytics.success && report.success && dashboard.success) {
                    updateDashboard(analytics.data, report.data, dashboard.data);
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        function updateDashboard(analytics, report, dashboard) {
            const metrics = analytics.metrics || {};
            const deals = report.deals || {};
            const revenue = report.revenue || {};

            // Main stats
            document.getElementById('totalRevenue').textContent = '$' + formatNumber(revenue.total || 0);
            document.getElementById('totalDeals').textContent = deals.total || 0;
            document.getElementById('dealsChange').textContent = `${deals.closed || 0} closed`;
            document.getElementById('avgDealSize').textContent = '$' + formatNumber(revenue.avgDealSize || 0);
            document.getElementById('conversionRate').textContent = (metrics.conversionRate || 0) + '%';

            // Donut chart
            const total = deals.total || 1;
            const wsDeals = deals.byType?.wholesaling || 0;
            const s2Deals = deals.byType?.sub2 || 0;
            const otherDeals = deals.byType?.other || 0;

            const wsDeg = (wsDeals / total) * 360;
            const s2Deg = wsDeg + (s2Deals / total) * 360;

            const donut = document.getElementById('dealDonut');
            donut.style.setProperty('--wholesale-deg', `${wsDeg}deg`);
            donut.style.setProperty('--sub2-deg', `${s2Deg}deg`);

            document.getElementById('donutTotal').textContent = total;
            document.getElementById('wsCount').textContent = wsDeals;
            document.getElementById('s2Count').textContent = s2Deals;
            document.getElementById('otherCount').textContent = otherDeals;

            // Pipeline chart
            const stages = ['Lead', 'Contact', 'Analysis', 'Contract', 'Marketed', 'Closed'];
            const stageCounts = [
                deals.active || 0,
                Math.floor((deals.active || 0) * 0.8),
                Math.floor((deals.active || 0) * 0.6),
                Math.floor((deals.active || 0) * 0.4),
                Math.floor((deals.active || 0) * 0.3),
                deals.closed || 0
            ];
            const maxCount = Math.max(...stageCounts, 1);

            document.getElementById('pipelineChart').innerHTML = stages.map((stage, i) => `
                <div class="bar-item">
                    <div class="bar-value">${stageCounts[i]}</div>
                    <div class="bar" style="height: ${(stageCounts[i] / maxCount) * 150}px;"></div>
                    <div class="bar-label">${stage}</div>
                </div>
            `).join('');

            // KPIs
            document.getElementById('propertiesAnalyzed').textContent = report.properties?.total || 0;
            document.getElementById('activeBuyers').textContent = report.contacts?.activeBuyers || 0;
            document.getElementById('activeSellers').textContent = report.contacts?.activeSellers || 0;
            document.getElementById('pendingTasks').textContent = dashboard.pendingTasks || 0;

            // Revenue breakdown
            document.getElementById('wsRevenue').textContent = '$' + formatNumber((revenue.total || 0) * 0.6);
            document.getElementById('s2Revenue').textContent = '$' + formatNumber((revenue.total || 0) * 0.3);
            document.getElementById('otherRevenue').textContent = '$' + formatNumber((revenue.total || 0) * 0.1);
            document.getElementById('totalProfit').textContent = '$' + formatNumber(metrics.totalProfit || revenue.total || 0);

            // Performance metrics
            document.getElementById('avgCloseTime').textContent = (metrics.avgDealTime || 30) + ' days';
            document.getElementById('responseRate').textContent = '85%';
            document.getElementById('pipelineDeals').textContent = deals.active || 0;
            document.getElementById('pipelineValue').textContent = '$' + formatNumber((deals.active || 0) * (revenue.avgDealSize || 15000));

            // Recent deals
            if (dashboard.recentDeals && dashboard.recentDeals.length > 0) {
                document.getElementById('recentDealsBody').innerHTML = dashboard.recentDeals
                    .filter(d => d.status === 'Closed')
                    .slice(0, 5)
                    .map(d => `
                        <tr>
                            <td>${d.address || 'N/A'}</td>
                            <td>${d.type}</td>
                            <td>$${formatNumber(d.purchasePrice || 0)}</td>
                            <td style="color: #4caf50; font-weight: bold;">$${formatNumber(d.assignmentFee || d.profit || 0)}</td>
                            <td>${new Date(d.updatedAt).toLocaleDateString()}</td>
                        </tr>
                    `).join('') || '<tr><td colspan="5" style="text-align: center; color: #999; padding: 30px;">No closed deals yet</td></tr>';
            }
        }

        async function exportReport(format) {
            try {
                const response = await fetch(`${API_BASE}/reports/summary`);
                const result = await response.json();

                if (result.success) {
                    let content, filename, type;

                    if (format === 'json') {
                        content = JSON.stringify(result.data, null, 2);
                        filename = 'report.json';
                        type = 'application/json';
                    } else {
                        // CSV format
                        const data = result.data;
                        content = `Metric,Value
Total Deals,${data.deals?.total || 0}
Active Deals,${data.deals?.active || 0}
Closed Deals,${data.deals?.closed || 0}
Wholesaling Deals,${data.deals?.byType?.wholesaling || 0}
Sub2 Deals,${data.deals?.byType?.sub2 || 0}
Total Revenue,$${data.revenue?.total || 0}
Average Deal Size,$${data.revenue?.avgDealSize || 0}
Total Buyers,${data.contacts?.totalBuyers || 0}
Active Buyers,${data.contacts?.activeBuyers || 0}
Total Sellers,${data.contacts?.totalSellers || 0}
Properties Analyzed,${data.properties?.total || 0}
Generated,${data.generatedAt}`;
                        filename = 'report.csv';
                        type = 'text/csv';
                    }

                    const blob = new Blob([content], { type });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                }
            } catch (error) {
                alert('Error exporting: ' + error.message);
            }
        }

        function formatNumber(num) {
            return Math.round(num).toLocaleString();
        }

        loadAnalytics();
    </script>
</body>
</html>
