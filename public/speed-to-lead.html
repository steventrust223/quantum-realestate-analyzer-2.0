<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed-to-Lead - Quantum Real Estate Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .back-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Alert Banner */
        .alert-banner {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: pulse 2s infinite;
        }

        .alert-banner.no-alerts {
            background: linear-gradient(135deg, #00b894, #00cec9);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
        }

        .alert-content h2 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .alert-content p {
            opacity: 0.9;
        }

        .alert-action {
            padding: 12px 24px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .alert-action:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .stat-card.highlight {
            background: linear-gradient(135deg, rgba(0,255,136,0.1), rgba(0,212,255,0.1));
            border-color: rgba(0,255,136,0.3);
        }

        .stat-label {
            font-size: 14px;
            color: rgba(255,255,255,0.6);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
        }

        .stat-value.good { color: #00ff88; }
        .stat-value.warning { color: #ffc107; }
        .stat-value.danger { color: #ff6b6b; }

        .stat-subtitle {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            margin-top: 5px;
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Lead Queue */
        .lead-queue {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
        }

        .filter-tab {
            padding: 6px 12px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .filter-tab.active {
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            color: #1a1a2e;
        }

        .lead-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .lead-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .lead-item:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.1);
        }

        .lead-item.hot {
            border-left: 4px solid #ff6b6b;
        }

        .lead-item.warm {
            border-left: 4px solid #ffc107;
        }

        .lead-item.cooling {
            border-left: 4px solid #00d4ff;
        }

        .lead-item.cold {
            border-left: 4px solid #6c757d;
        }

        .urgency-badge {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            margin-right: 15px;
        }

        .urgency-badge.hot {
            background: rgba(255,107,107,0.2);
            color: #ff6b6b;
        }

        .urgency-badge.warm {
            background: rgba(255,193,7,0.2);
            color: #ffc107;
        }

        .urgency-badge.cooling {
            background: rgba(0,212,255,0.2);
            color: #00d4ff;
        }

        .urgency-badge.cold {
            background: rgba(108,117,125,0.2);
            color: #6c757d;
        }

        .lead-info {
            flex: 1;
        }

        .lead-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .lead-details {
            font-size: 13px;
            color: rgba(255,255,255,0.6);
        }

        .lead-timer {
            text-align: right;
        }

        .timer-value {
            font-size: 20px;
            font-weight: 700;
        }

        .timer-label {
            font-size: 11px;
            color: rgba(255,255,255,0.5);
        }

        .lead-actions {
            display: flex;
            gap: 10px;
            margin-left: 15px;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            color: #1a1a2e;
        }

        .action-btn.secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Conversion Chart */
        .conversion-chart {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .chart-bars {
            margin-top: 20px;
        }

        .chart-bar {
            margin-bottom: 15px;
        }

        .chart-bar-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .chart-bar-fill {
            height: 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
            overflow: hidden;
        }

        .chart-bar-fill-inner {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .chart-bar-fill-inner.excellent { background: linear-gradient(90deg, #00ff88, #00d4ff); }
        .chart-bar-fill-inner.good { background: #00d4ff; }
        .chart-bar-fill-inner.fair { background: #ffc107; }
        .chart-bar-fill-inner.poor { background: #ff6b6b; }

        /* Auto Response Panel */
        .auto-response-panel {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .toggle-row:last-child {
            border-bottom: none;
        }

        .toggle-label {
            font-size: 14px;
        }

        .toggle-switch {
            width: 50px;
            height: 26px;
            background: rgba(255,255,255,0.1);
            border-radius: 13px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: linear-gradient(135deg, #00ff88, #00d4ff);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }

        .toggle-switch.active::after {
            left: 26px;
        }

        .template-select {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            margin-top: 15px;
        }

        .template-select option {
            background: #1a1a2e;
        }

        /* Quick Actions */
        .quick-actions {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .quick-action-btn {
            width: 100%;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
        }

        .quick-action-btn:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }

        .quick-action-btn:last-child {
            margin-bottom: 0;
        }

        .quick-action-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .quick-action-icon.call { background: rgba(0,255,136,0.2); }
        .quick-action-icon.email { background: rgba(0,212,255,0.2); }
        .quick-action-icon.sms { background: rgba(255,193,7,0.2); }
        .quick-action-icon.bulk { background: rgba(155,89,182,0.2); }

        /* Response Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #1a1a2e;
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.6;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            margin-bottom: 8px;
            color: rgba(255,255,255,0.8);
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        /* Performance History */
        .performance-history {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            margin-top: 30px;
        }

        .history-chart {
            height: 200px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            padding: 20px 0;
        }

        .history-bar {
            flex: 1;
            background: linear-gradient(180deg, #00ff88, #00d4ff);
            border-radius: 4px 4px 0 0;
            min-height: 10px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .history-bar:hover {
            opacity: 0.8;
        }

        .history-bar::after {
            content: attr(data-label);
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: rgba(255,255,255,0.5);
        }

        .history-legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 40px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: rgba(255,255,255,0.6);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            color: #1a1a2e;
            font-weight: 500;
            transform: translateX(400px);
            transition: all 0.3s;
            z-index: 2000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: #fff;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255,255,255,0.5);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        /* Audio Alert */
        .audio-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            cursor: pointer;
        }

        .audio-toggle.muted {
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Speed-to-Lead Dashboard</h1>
            <div class="header-actions">
                <div class="audio-toggle" onclick="toggleAudio()" id="audioToggle">
                    <span id="audioIcon">üîî</span>
                    <span>Alerts</span>
                </div>
                <a href="control-center.html" class="back-btn">‚Üê Back to Control Center</a>
            </div>
        </div>

        <!-- Alert Banner -->
        <div class="alert-banner" id="alertBanner">
            <div class="alert-content">
                <h2 id="alertTitle">Loading...</h2>
                <p id="alertSubtitle">Checking for urgent leads...</p>
            </div>
            <button class="alert-action" onclick="respondToUrgent()" id="alertAction">Respond Now</button>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card highlight">
                <div class="stat-label">Average Response Time</div>
                <div class="stat-value" id="avgResponseTime">--</div>
                <div class="stat-subtitle">Target: Under 5 minutes</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Pending Leads</div>
                <div class="stat-value" id="pendingLeads">0</div>
                <div class="stat-subtitle">Awaiting first response</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Leads Responded Today</div>
                <div class="stat-value good" id="respondedToday">0</div>
                <div class="stat-subtitle">Within SLA: <span id="withinSLA">0%</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Conversion Rate</div>
                <div class="stat-value" id="conversionRate">--%</div>
                <div class="stat-subtitle">From quick responses</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Hot Leads</div>
                <div class="stat-value danger" id="hotLeadsCount">0</div>
                <div class="stat-subtitle">Response needed now!</div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Lead Queue -->
            <div class="lead-queue">
                <div class="section-header">
                    <h3 class="section-title">Lead Response Queue</h3>
                    <div class="filter-tabs">
                        <button class="filter-tab active" onclick="filterLeads('all')">All</button>
                        <button class="filter-tab" onclick="filterLeads('hot')">Hot</button>
                        <button class="filter-tab" onclick="filterLeads('warm')">Warm</button>
                        <button class="filter-tab" onclick="filterLeads('cooling')">Cooling</button>
                    </div>
                </div>
                <div class="lead-list" id="leadList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>No pending leads</p>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Conversion Probability -->
                <div class="conversion-chart">
                    <h3 class="section-title">Conversion Probability by Response Time</h3>
                    <div class="chart-bars">
                        <div class="chart-bar">
                            <div class="chart-bar-header">
                                <span>Under 5 min</span>
                                <span>~400% higher</span>
                            </div>
                            <div class="chart-bar-fill">
                                <div class="chart-bar-fill-inner excellent" style="width: 100%"></div>
                            </div>
                        </div>
                        <div class="chart-bar">
                            <div class="chart-bar-header">
                                <span>5-15 min</span>
                                <span>~200% higher</span>
                            </div>
                            <div class="chart-bar-fill">
                                <div class="chart-bar-fill-inner good" style="width: 75%"></div>
                            </div>
                        </div>
                        <div class="chart-bar">
                            <div class="chart-bar-header">
                                <span>15-30 min</span>
                                <span>~50% higher</span>
                            </div>
                            <div class="chart-bar-fill">
                                <div class="chart-bar-fill-inner fair" style="width: 45%"></div>
                            </div>
                        </div>
                        <div class="chart-bar">
                            <div class="chart-bar-header">
                                <span>30+ min</span>
                                <span>Baseline</span>
                            </div>
                            <div class="chart-bar-fill">
                                <div class="chart-bar-fill-inner poor" style="width: 20%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Auto Response Panel -->
                <div class="auto-response-panel">
                    <h3 class="section-title">Auto-Response Settings</h3>
                    <div class="toggle-row">
                        <span class="toggle-label">Enable Auto-Response</span>
                        <div class="toggle-switch" id="autoResponseToggle" onclick="toggleAutoResponse()"></div>
                    </div>
                    <div class="toggle-row">
                        <span class="toggle-label">Browser Notifications</span>
                        <div class="toggle-switch active" id="browserNotifToggle" onclick="toggleBrowserNotifications()"></div>
                    </div>
                    <div class="toggle-row">
                        <span class="toggle-label">Email Alerts</span>
                        <div class="toggle-switch active" id="emailAlertToggle" onclick="toggleEmailAlerts()"></div>
                    </div>
                    <select class="template-select" id="templateSelect">
                        <option value="">Select Auto-Response Template</option>
                    </select>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h3 class="section-title">Quick Actions</h3>
                    <button class="quick-action-btn" onclick="openResponseModal('call')">
                        <div class="quick-action-icon call">üìû</div>
                        <span>Log Phone Response</span>
                    </button>
                    <button class="quick-action-btn" onclick="openResponseModal('email')">
                        <div class="quick-action-icon email">üìß</div>
                        <span>Send Email Response</span>
                    </button>
                    <button class="quick-action-btn" onclick="openResponseModal('sms')">
                        <div class="quick-action-icon sms">üí¨</div>
                        <span>Send SMS Response</span>
                    </button>
                    <button class="quick-action-btn" onclick="bulkRespond()">
                        <div class="quick-action-icon bulk">‚ö°</div>
                        <span>Bulk Auto-Respond</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Performance History -->
        <div class="performance-history">
            <h3 class="section-title">7-Day Response Time History</h3>
            <div class="history-chart" id="historyChart">
                <!-- Bars will be populated dynamically -->
            </div>
            <div class="history-legend">
                <div class="legend-item">
                    <div class="legend-dot" style="background: #00ff88;"></div>
                    <span>Excellent (&lt;5 min)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #00d4ff;"></div>
                    <span>Good (5-15 min)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #ffc107;"></div>
                    <span>Fair (15-30 min)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #ff6b6b;"></div>
                    <span>Needs Improvement (&gt;30 min)</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Response Modal -->
    <div class="modal-overlay" id="responseModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Log Response</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="responseForm" onsubmit="submitResponse(event)">
                <input type="hidden" id="responseLeadId">
                <input type="hidden" id="responseType">
                <div class="form-group">
                    <label class="form-label">Lead</label>
                    <input type="text" class="form-input" id="responseLead" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Response Notes</label>
                    <textarea class="form-textarea" id="responseNotes" placeholder="Enter response details..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Outcome</label>
                    <select class="form-input" id="responseOutcome">
                        <option value="contacted">Successfully Contacted</option>
                        <option value="voicemail">Left Voicemail</option>
                        <option value="no-answer">No Answer</option>
                        <option value="scheduled">Scheduled Callback</option>
                        <option value="qualified">Qualified - Moving Forward</option>
                        <option value="not-interested">Not Interested</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="action-btn secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="action-btn primary">Log Response</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        const API_BASE = '/api';
        let urgentLeads = [];
        let allLeads = [];
        let currentFilter = 'all';
        let audioEnabled = true;
        let selectedLeadId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
            loadTemplates();
            loadSettings();

            // Refresh every 30 seconds
            setInterval(loadDashboard, 30000);

            // Request notification permission
            if ('Notification' in window) {
                Notification.requestPermission();
            }
        });

        async function loadDashboard() {
            try {
                const [dashboardRes, urgentRes] = await Promise.all([
                    fetch(`${API_BASE}/speed-to-lead/dashboard`),
                    fetch(`${API_BASE}/speed-to-lead/urgent`)
                ]);

                const dashboardData = await dashboardRes.json();
                const urgentData = await urgentRes.json();

                if (dashboardData.success) {
                    updateStats(dashboardData.data);
                }

                if (urgentData.success) {
                    urgentLeads = urgentData.data;
                    allLeads = urgentData.data;
                    updateAlertBanner();
                    renderLeadList();
                }

                renderHistoryChart();
            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }

        function updateStats(data) {
            // Average response time
            const avgTime = data.metrics?.averageResponseTimeMinutes;
            const avgTimeEl = document.getElementById('avgResponseTime');
            if (avgTime !== undefined && avgTime !== null) {
                avgTimeEl.textContent = formatTime(avgTime);
                avgTimeEl.className = 'stat-value ' + (avgTime < 5 ? 'good' : avgTime < 15 ? 'warning' : 'danger');
            } else {
                avgTimeEl.textContent = '--';
            }

            // Pending leads
            document.getElementById('pendingLeads').textContent = data.metrics?.pendingLeads || 0;

            // Responded today
            document.getElementById('respondedToday').textContent = data.metrics?.respondedToday || 0;
            document.getElementById('withinSLA').textContent =
                (data.metrics?.withinSLAPercent || 0).toFixed(0) + '%';

            // Conversion rate
            const convRate = data.metrics?.conversionRate;
            document.getElementById('conversionRate').textContent =
                convRate !== undefined ? convRate.toFixed(1) + '%' : '--%';

            // Hot leads count
            const hotCount = urgentLeads.filter(l => l.urgency === 'hot').length;
            document.getElementById('hotLeadsCount').textContent = hotCount;
        }

        function updateAlertBanner() {
            const banner = document.getElementById('alertBanner');
            const title = document.getElementById('alertTitle');
            const subtitle = document.getElementById('alertSubtitle');
            const action = document.getElementById('alertAction');

            const hotLeads = urgentLeads.filter(l => l.urgency === 'hot');
            const warmLeads = urgentLeads.filter(l => l.urgency === 'warm');

            if (hotLeads.length > 0) {
                banner.className = 'alert-banner';
                title.textContent = `üî• ${hotLeads.length} HOT Lead${hotLeads.length > 1 ? 's' : ''} Waiting!`;
                subtitle.textContent = 'Respond within 5 minutes to maximize conversion';
                action.style.display = 'block';

                // Send browser notification
                if (audioEnabled && Notification.permission === 'granted') {
                    new Notification('Hot Lead Alert!', {
                        body: `${hotLeads.length} lead(s) need immediate response`,
                        icon: 'üî•'
                    });
                }
            } else if (warmLeads.length > 0) {
                banner.className = 'alert-banner';
                banner.style.background = 'linear-gradient(135deg, #ffc107, #ff9800)';
                title.textContent = `‚ö° ${warmLeads.length} Warm Lead${warmLeads.length > 1 ? 's' : ''} in Queue`;
                subtitle.textContent = 'Respond soon to maintain high conversion rates';
                action.style.display = 'block';
            } else if (urgentLeads.length > 0) {
                banner.className = 'alert-banner no-alerts';
                title.textContent = '‚úÖ All Leads Under Control';
                subtitle.textContent = `${urgentLeads.length} lead(s) in queue - keep up the great work!`;
                action.style.display = 'none';
            } else {
                banner.className = 'alert-banner no-alerts';
                title.textContent = 'üì≠ No Pending Leads';
                subtitle.textContent = 'All leads have been responded to';
                action.style.display = 'none';
            }
        }

        function renderLeadList() {
            const list = document.getElementById('leadList');
            let leads = currentFilter === 'all' ? allLeads : allLeads.filter(l => l.urgency === currentFilter);

            if (leads.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>No ${currentFilter === 'all' ? 'pending' : currentFilter} leads</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = leads.map(lead => `
                <div class="lead-item ${lead.urgency}" onclick="selectLead('${lead.id}')">
                    <div class="urgency-badge ${lead.urgency}">
                        ${lead.urgency === 'hot' ? 'üî•' : lead.urgency === 'warm' ? '‚ö°' : lead.urgency === 'cooling' ? '‚ùÑÔ∏è' : 'üïê'}
                    </div>
                    <div class="lead-info">
                        <div class="lead-name">${lead.name || 'Unknown Lead'}</div>
                        <div class="lead-details">
                            ${lead.source || 'Direct'} ‚Ä¢ ${lead.phone || lead.email || 'No contact'} ‚Ä¢
                            Priority: ${lead.priority || 50}/100
                        </div>
                    </div>
                    <div class="lead-timer">
                        <div class="timer-value ${lead.urgency === 'hot' ? 'danger' : lead.urgency === 'warm' ? 'warning' : ''}">${formatWaitTime(lead.waitTimeMinutes)}</div>
                        <div class="timer-label">waiting</div>
                    </div>
                    <div class="lead-actions">
                        <button class="action-btn primary" onclick="event.stopPropagation(); respondToLead('${lead.id}')">Respond</button>
                        <button class="action-btn secondary" onclick="event.stopPropagation(); viewLead('${lead.id}')">View</button>
                    </div>
                </div>
            `).join('');
        }

        function filterLeads(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.toggle('active', tab.textContent.toLowerCase() === filter);
            });
            renderLeadList();
        }

        function formatTime(minutes) {
            if (minutes < 1) return '<1 min';
            if (minutes < 60) return `${Math.round(minutes)} min`;
            const hours = Math.floor(minutes / 60);
            const mins = Math.round(minutes % 60);
            return `${hours}h ${mins}m`;
        }

        function formatWaitTime(minutes) {
            if (!minutes) return '--';
            if (minutes < 1) return '<1m';
            if (minutes < 60) return `${Math.round(minutes)}m`;
            const hours = Math.floor(minutes / 60);
            const mins = Math.round(minutes % 60);
            return `${hours}h ${mins}m`;
        }

        function selectLead(id) {
            selectedLeadId = id;
            document.querySelectorAll('.lead-item').forEach(item => {
                item.style.borderColor = item.classList.contains(id) ? '#00ff88' : 'transparent';
            });
        }

        async function respondToLead(id) {
            const lead = allLeads.find(l => l.id === id);
            if (!lead) return;

            selectedLeadId = id;
            openResponseModal('call', lead);
        }

        function respondToUrgent() {
            const hotLead = urgentLeads.find(l => l.urgency === 'hot') || urgentLeads[0];
            if (hotLead) {
                respondToLead(hotLead.id);
            }
        }

        function viewLead(id) {
            window.location.href = `marketing.html?lead=${id}`;
        }

        function openResponseModal(type, lead = null) {
            const modal = document.getElementById('responseModal');
            const title = document.getElementById('modalTitle');
            const leadInput = document.getElementById('responseLead');

            document.getElementById('responseType').value = type;

            const typeNames = {
                call: 'Log Phone Response',
                email: 'Send Email Response',
                sms: 'Send SMS Response'
            };
            title.textContent = typeNames[type] || 'Log Response';

            if (lead) {
                selectedLeadId = lead.id;
                leadInput.value = lead.name || lead.email || lead.phone || 'Unknown Lead';
            } else if (selectedLeadId) {
                const selectedLead = allLeads.find(l => l.id === selectedLeadId);
                leadInput.value = selectedLead ? (selectedLead.name || selectedLead.email || 'Unknown Lead') : '';
            } else {
                leadInput.value = 'Select a lead from the queue';
            }

            document.getElementById('responseLeadId').value = selectedLeadId || '';
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('responseModal').classList.remove('active');
            document.getElementById('responseForm').reset();
        }

        async function submitResponse(event) {
            event.preventDefault();

            const leadId = document.getElementById('responseLeadId').value;
            if (!leadId) {
                showNotification('Please select a lead first', 'error');
                return;
            }

            const responseData = {
                type: document.getElementById('responseType').value,
                notes: document.getElementById('responseNotes').value,
                outcome: document.getElementById('responseOutcome').value,
                respondedAt: new Date().toISOString()
            };

            try {
                const res = await fetch(`${API_BASE}/leads/${leadId}/respond`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(responseData)
                });

                const data = await res.json();
                if (data.success) {
                    showNotification('Response logged successfully!');
                    closeModal();
                    loadDashboard();
                } else {
                    showNotification(data.error || 'Failed to log response', 'error');
                }
            } catch (error) {
                showNotification('Error logging response', 'error');
            }
        }

        async function bulkRespond() {
            const templateId = document.getElementById('templateSelect').value;
            if (!templateId) {
                showNotification('Please select an auto-response template first', 'error');
                return;
            }

            const pendingCount = urgentLeads.length;
            if (pendingCount === 0) {
                showNotification('No pending leads to respond to');
                return;
            }

            if (!confirm(`Send auto-response to ${pendingCount} pending lead(s)?`)) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/speed-to-lead/bulk-respond`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ templateId, maxLeads: 50 })
                });

                const data = await res.json();
                if (data.success) {
                    showNotification(`Auto-response sent to ${data.data.responded} lead(s)`);
                    loadDashboard();
                } else {
                    showNotification(data.error || 'Bulk respond failed', 'error');
                }
            } catch (error) {
                showNotification('Error sending bulk response', 'error');
            }
        }

        async function loadTemplates() {
            try {
                const res = await fetch(`${API_BASE}/speed-to-lead/templates`);
                const data = await res.json();

                const select = document.getElementById('templateSelect');
                if (data.success && data.data.length > 0) {
                    data.data.forEach(template => {
                        const option = document.createElement('option');
                        option.value = template.id;
                        option.textContent = template.name;
                        select.appendChild(option);
                    });
                } else {
                    // Add default templates
                    const defaultTemplates = [
                        { id: 'default-1', name: 'Quick Introduction' },
                        { id: 'default-2', name: 'Property Inquiry Response' },
                        { id: 'default-3', name: 'Schedule Call Request' }
                    ];
                    defaultTemplates.forEach(template => {
                        const option = document.createElement('option');
                        option.value = template.id;
                        option.textContent = template.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load templates:', error);
            }
        }

        async function loadSettings() {
            try {
                const res = await fetch(`${API_BASE}/speed-to-lead/settings`);
                const data = await res.json();

                if (data.success) {
                    const settings = data.data;
                    if (settings.autoResponseEnabled) {
                        document.getElementById('autoResponseToggle').classList.add('active');
                    }
                    if (settings.notifications?.browser !== false) {
                        document.getElementById('browserNotifToggle').classList.add('active');
                    }
                    if (settings.notifications?.email !== false) {
                        document.getElementById('emailAlertToggle').classList.add('active');
                    }
                }
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        }

        function toggleAutoResponse() {
            const toggle = document.getElementById('autoResponseToggle');
            toggle.classList.toggle('active');
            updateSettings({ autoResponseEnabled: toggle.classList.contains('active') });
        }

        function toggleBrowserNotifications() {
            const toggle = document.getElementById('browserNotifToggle');
            toggle.classList.toggle('active');

            if (toggle.classList.contains('active') && Notification.permission !== 'granted') {
                Notification.requestPermission();
            }
        }

        function toggleEmailAlerts() {
            const toggle = document.getElementById('emailAlertToggle');
            toggle.classList.toggle('active');
        }

        async function updateSettings(settings) {
            try {
                await fetch(`${API_BASE}/speed-to-lead/settings`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
            } catch (error) {
                console.error('Failed to update settings:', error);
            }
        }

        function toggleAudio() {
            audioEnabled = !audioEnabled;
            const toggle = document.getElementById('audioToggle');
            const icon = document.getElementById('audioIcon');
            toggle.classList.toggle('muted', !audioEnabled);
            icon.textContent = audioEnabled ? 'üîî' : 'üîï';
        }

        function renderHistoryChart() {
            const chart = document.getElementById('historyChart');
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const today = new Date().getDay();

            // Generate mock data for visualization (would be real data in production)
            const data = [];
            for (let i = 6; i >= 0; i--) {
                const dayIndex = (today - i + 7) % 7;
                const avgMinutes = Math.random() * 25 + 3; // Random 3-28 minutes
                data.push({
                    day: days[dayIndex],
                    avgMinutes,
                    height: Math.min(100, (30 - avgMinutes) / 30 * 100 + 20)
                });
            }

            chart.innerHTML = data.map((d, i) => `
                <div class="history-bar"
                     style="height: ${d.height}%; background: ${getBarColor(d.avgMinutes)}"
                     data-label="${d.day}"
                     title="${d.day}: ${d.avgMinutes.toFixed(1)} min avg">
                </div>
            `).join('');
        }

        function getBarColor(minutes) {
            if (minutes < 5) return 'linear-gradient(180deg, #00ff88, #00d4ff)';
            if (minutes < 15) return 'linear-gradient(180deg, #00d4ff, #00b4cc)';
            if (minutes < 30) return 'linear-gradient(180deg, #ffc107, #ff9800)';
            return 'linear-gradient(180deg, #ff6b6b, #ee5a24)';
        }

        function showNotification(message, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.className = 'notification ' + (type === 'error' ? 'error ' : '') + 'show';

            setTimeout(() => {
                notif.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
